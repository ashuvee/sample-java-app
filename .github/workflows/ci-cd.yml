name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NEXUS_URL: 'http://3.85.143.154:8081'
  NEXUS_REPO: 'my-java-app'
  NEXUS_GROUP: 'com/web/app'
  NEXUS_ARTIFACT: 'my-app'
  SONAR_HOST_URL: 'http://100.25.217.210:9000'
  TOMCAT_URL: 'http://3.88.108.148:8080/manager/text'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì¶ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: üîç SonarQube Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        echo "Running SonarQube static analysis..."
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=sample-java-app \
          -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
          -Dsonar.login=$SONAR_TOKEN \
          -DskipTests

    - name: ‚öôÔ∏è Build WAR Artifact
      run: |
        echo "Building WAR file..."
        mvn clean package -DskipTests
        echo "‚úÖ Build Completed!"
        ls -lh target/*.war || true

    - name: üì§ Upload Artifact to Nexus
      env:
        NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      run: |
        set -e
        WAR_FILE=$(ls target/*.war | head -1)
        FILE_NAME=$(basename "$WAR_FILE")
        VERSION="0.0.${{ github.run_number }}"
        
        echo "üì§ Uploading $FILE_NAME to Nexus as version $VERSION..."
        
        curl -v -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} \
          --upload-file "$WAR_FILE" \
          "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.war"
        
        echo "‚úÖ Artifact uploaded successfully to Nexus!"

    - name: üöÄ Deploy to Tomcat
      env:
        NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        TOMCAT_USERNAME: ${{ secrets.TOMCAT_USERNAME }}
        TOMCAT_PASSWORD: ${{ secrets.TOMCAT_PASSWORD }}
      run: |
        set -e
        cd /tmp
        rm -f *.war || true
        
        echo "üîç Fetching latest WAR from Nexus..."
        DOWNLOAD_URL=$(curl -s -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} \
          "${NEXUS_URL}/service/rest/v1/search?repository=${NEXUS_REPO}&group=com.web.app&name=my-app" \
          | grep -oP '"downloadUrl"\s*:\s*"\K[^"]+\.war' | grep -vE '\.md5|\.sha1' | tail -1)
        
        if [[ -z "$DOWNLOAD_URL" ]]; then
          echo "‚ùå No WAR found in Nexus!"
          exit 1
        fi
        
        echo "‚¨áÔ∏è Downloading WAR: $DOWNLOAD_URL"
        curl -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} -O "$DOWNLOAD_URL"
        WAR_FILE=$(basename "$DOWNLOAD_URL")
        APP_NAME=$(echo "$WAR_FILE" | sed 's/-[0-9].*//')
        
        echo "üßπ Removing old deployment..."
        curl -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
          "${TOMCAT_URL}/undeploy?path=/${APP_NAME}" || true
        
        echo "üöÄ Deploying new WAR to Tomcat..."
        curl -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
          --upload-file "$WAR_FILE" \
          "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"
        
        echo "‚úÖ Deployment successful! Application updated."

    - name: üìä Summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ Pipeline completed successfully ‚Äî Application live on Tomcat!"
        else
          echo "‚ùå Pipeline failed ‚Äî Check GitHub Actions logs."
        fi
