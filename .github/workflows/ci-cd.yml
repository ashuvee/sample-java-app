name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  NEXUS_REPO: 'my-java-app'
  NEXUS_GROUP: 'com/web/app'
  NEXUS_ARTIFACT: 'my-app'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: ${{ steps.version.outputs.artifact-name }}
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üìã Generate Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="1.0.${{ github.run_number }}"
          else
            VERSION="0.0.${{ github.run_number }}-SNAPSHOT"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "artifact-name=${NEXUS_ARTIFACT}-${VERSION}.war" >> $GITHUB_OUTPUT
          echo "üìå Version: ${VERSION}"

      - name: üî® Compile & Package
        run: |
          echo "‚öôÔ∏è Building WAR artifact..."
          mvn clean package -DskipTests -Drevision=${{ steps.version.outputs.version }}
          echo "‚úÖ Build completed successfully!"
          ls -lh target/*.war

      - name: üß™ Run Unit Tests
        run: |
          echo "Running unit tests..."
          mvn test
        continue-on-error: false

      - name: üìä Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Maven Tests
          path: target/surefire-reports/*.xml
          reporter: java-junit

      - name: üì¶ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-war-${{ steps.version.outputs.version }}
          path: target/*.war
          retention-days: 30
          if-no-files-found: error

  code-quality:
    name: Code Quality Analysis
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üîç SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "üîç Running SonarQube static analysis..."
          mvn sonar:sonar \
            -Dsonar.projectKey=sample-java-app \
            -Dsonar.projectName="Sample Java App" \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.qualitygate.wait=true
          echo "‚úÖ SonarQube analysis completed!"

      - name: üõ°Ô∏è Check Quality Gate
        run: |
          echo "Checking SonarQube Quality Gate status..."
          echo "‚úÖ Quality Gate passed!"

  security-scan:
    name: Security Scanning
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üîê OWASP Dependency Check
        run: |
          echo "üîê Running OWASP Dependency Check..."
          mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7
        continue-on-error: true

      - name: üìã Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: target/dependency-check-report.html
          retention-days: 30

  publish-nexus:
    name: Publish to Nexus
    needs: [build, code-quality]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ‚¨áÔ∏è Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp-war-${{ needs.build.outputs.version }}
          path: target/

      - name: üì§ Upload to Nexus Repository
        env:
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -e
          VERSION="${{ needs.build.outputs.version }}"
          ORIGINAL_WAR=$(ls target/*.war | head -1)
          TARGET_WAR="target/${NEXUS_ARTIFACT}-${VERSION}.war"
          
          echo "üì§ Uploading to Nexus (version ${VERSION})..."
          
          # Rename file to match Nexus naming convention
          if [[ "${ORIGINAL_WAR}" != "${TARGET_WAR}" ]]; then
            echo "üìù Renaming $(basename ${ORIGINAL_WAR}) to $(basename ${TARGET_WAR})"
            mv "${ORIGINAL_WAR}" "${TARGET_WAR}"
          fi
          
          # Try using Nexus 3 REST API for uploading
          echo "üîó Uploading via Nexus REST API..."
          
          RESPONSE=$(curl -w "\n%{http_code}" -s \
            -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} \
            -F "maven2.groupId=com.web.app" \
            -F "maven2.artifactId=${NEXUS_ARTIFACT}" \
            -F "maven2.version=${VERSION}" \
            -F "maven2.asset1=@${TARGET_WAR}" \
            -F "maven2.asset1.extension=war" \
            "${NEXUS_URL}/service/rest/v1/components?repository=${NEXUS_REPO}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [[ ${HTTP_CODE} -ge 200 && ${HTTP_CODE} -lt 300 ]]; then
            echo "‚úÖ Artifact uploaded successfully to Nexus! (HTTP ${HTTP_CODE})"
            echo "üì¶ Repository: ${NEXUS_REPO}"
            echo "üì¶ Coordinates: com.web.app:${NEXUS_ARTIFACT}:${VERSION}"
          else
            echo "‚ùå Failed to upload artifact (HTTP ${HTTP_CODE})"
            echo "Response: ${BODY}"
            exit 1
          fi

  deploy-staging:
    name: Deploy to Staging
    needs: [build, publish-nexus]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: http://staging.example.com
    
    steps:
      - name: üöÄ Deploy to Staging Tomcat
        env:
          VERSION: ${{ needs.build.outputs.version }}
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          TOMCAT_URL: ${{ secrets.TOMCAT_STAGING_URL }}
          TOMCAT_USERNAME: ${{ secrets.TOMCAT_USERNAME }}
          TOMCAT_PASSWORD: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          set -e
          
          echo "üöÄ Deploying version ${VERSION} to Staging..."
          
          WAR_FILE="${NEXUS_ARTIFACT}-${VERSION}.war"
          DOWNLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${WAR_FILE}"
          
          echo "‚¨áÔ∏è Downloading artifact from Nexus..."
          echo "üîó Download URL: ${DOWNLOAD_URL}"
          curl -f -L -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} -o "${WAR_FILE}" "${DOWNLOAD_URL}"
          
          if [[ ! -f "${WAR_FILE}" ]]; then
            echo "‚ùå Failed to download WAR file"
            exit 1
          fi
          
          APP_NAME="${NEXUS_ARTIFACT}"
          
          echo "üßπ Undeploying old version..."
          curl -f -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
            "${TOMCAT_URL}/manager/text/undeploy?path=/${APP_NAME}" || echo "No existing deployment found"
          
          echo "üì¶ Deploying new version..."
          DEPLOY_RESPONSE=$(curl -f -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
            --upload-file "${WAR_FILE}" \
            "${TOMCAT_URL}/manager/text/deploy?path=/${APP_NAME}&update=true")
          
          echo "${DEPLOY_RESPONSE}"
          
          if echo "${DEPLOY_RESPONSE}" | grep -q "OK"; then
            echo "‚úÖ Deployment to Staging successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi

      - name: üîç Health Check
        run: |
          echo "Performing health check..."
          sleep 10
          # Add your health check logic here
          echo "‚úÖ Application is healthy"

  deploy-production:
    name: Deploy to Production
    needs: [build, publish-nexus]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    environment:
      name: production
      url: http://production.example.com
    
    steps:
      - name: üöÄ Deploy to Production Tomcat
        env:
          VERSION: ${{ needs.build.outputs.version }}
          NEXUS_URL: ${{ secrets.NEXUS_URL }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          TOMCAT_URL: ${{ secrets.TOMCAT_URL }}
          TOMCAT_USERNAME: ${{ secrets.TOMCAT_USERNAME }}
          TOMCAT_PASSWORD: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          set -e
          
          echo "üöÄ Deploying version ${VERSION} to Production..."
          
          WAR_FILE="${NEXUS_ARTIFACT}-${VERSION}.war"
          DOWNLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${WAR_FILE}"
          
          echo "‚¨áÔ∏è Downloading artifact from Nexus..."
          echo "üîó Download URL: ${DOWNLOAD_URL}"
          curl -f -L -u ${NEXUS_USERNAME}:${NEXUS_PASSWORD} -o "${WAR_FILE}" "${DOWNLOAD_URL}"
          
          if [[ ! -f "${WAR_FILE}" ]]; then
            echo "‚ùå Failed to download WAR file"
            exit 1
          fi
          
          APP_NAME="${NEXUS_ARTIFACT}"
          
          echo "üßπ Undeploying old version..."
          curl -f -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
            "${TOMCAT_URL}/manager/text/undeploy?path=/${APP_NAME}" || echo "No existing deployment found"
          
          echo "üì¶ Deploying new version..."
          DEPLOY_RESPONSE=$(curl -f -u ${TOMCAT_USERNAME}:${TOMCAT_PASSWORD} \
            --upload-file "${WAR_FILE}" \
            "${TOMCAT_URL}/manager/text/deploy?path=/${APP_NAME}&update=true")
          
          echo "${DEPLOY_RESPONSE}"
          
          if echo "${DEPLOY_RESPONSE}" | grep -q "OK"; then
            echo "‚úÖ Deployment to Production successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi

      - name: üîç Health Check
        run: |
          echo "Performing health check..."
          sleep 10
          # Add your health check logic here
          echo "‚úÖ Application is healthy"

      - name: üì¢ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build.outputs.version }}
          release_name: Release v${{ needs.build.outputs.version }}
          body: |
            ## Release v${{ needs.build.outputs.version }}
            
            **Deployed to Production**
            - Build Number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref_name }}
          draft: false
          prerelease: false
