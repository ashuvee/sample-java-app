name: my-java-app

on:
  push:
    branches:
      - main

env:
  SONARQUBE_SERVER: sonar
  MVN_SETTINGS: "/etc/maven/settings.xml"
  NEXUS_URL: http://3.19.221.46:8081
  NEXUS_REPO: my-java-app
  NEXUS_GROUP: com.web.app          # Fixed: use dots, not slashes
  NEXUS_ARTIFACT: my-app
  TOMCAT_URL: http://18.116.203.32:8080/manager/text

jobs:
  Checkout_Code:
    name: Checkout Code
    runs-on: [self-hosted, sonar]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  SonarQube_Analysis:
    name: SonarQube Analysis
    runs-on: [self-hosted, sonar]
    needs: Checkout_Code
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run SonarQube Analysis
        run: echo "ğŸ” Running SonarQube static analysis..."

  Build_Artifact:
    name: Build Artifact
    runs-on: [self-hosted, sonar]
    needs: SonarQube_Analysis
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build WAR
        run: mvn clean package -DskipTests --settings "${{ env.MVN_SETTINGS }}"
      - name: Verify WAR
        run: ls -lh target/*.war || echo "âš ï¸ No WAR found"
      - name: Set version
        id: set_version
        run: echo "version=0.0.${{ github.run_number }}" >> $GITHUB_OUTPUT

  Upload_Artifact_to_Nexus:
    name: Upload Artifact to Nexus
    runs-on: [self-hosted, sonar]
    needs: Build_Artifact
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Upload to Nexus
        env:
          NEXUS_USR: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PSW: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -n1)
          if [ ! -f "$WAR_FILE" ]; then
            echo "âŒ No WAR file found in target/"
            exit 1
          fi
          VERSION="${{ needs.Build_Artifact.outputs.version }}"
          FILE_NAME="${{ env.NEXUS_ARTIFACT }}-$VERSION.war"
          echo "ğŸ“¤ Uploading $WAR_FILE as $FILE_NAME (version $VERSION) to Nexus..."
          
          UPLOAD_URL="${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP_PATH }}/${{ env.NEXUS_ARTIFACT }}/$VERSION/$FILE_NAME"
          
          # Convert group ID to path (e.g., com.web.app â†’ com/web/app)
          GROUP_PATH=$(echo "${{ env.NEXUS_GROUP }}" | tr '.' '/')
          UPLOAD_URL="${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/$GROUP_PATH/${{ env.NEXUS_ARTIFACT }}/$VERSION/$FILE_NAME"
          
          curl -f -u "$NEXUS_USR:$NEXUS_PSW" --upload-file "$WAR_FILE" "$UPLOAD_URL"
          echo "âœ… Artifact uploaded successfully to Nexus!"

  Deploy_to_Tomcat:
    name: Deploy to Tomcat
    runs-on: [self-hosted, tomcat]
    needs: Upload_Artifact_to_Nexus
    steps:
      - name: Deploy from Nexus to Tomcat
        env:
          NEXUS_USR: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PSW: ${{ secrets.NEXUS_PASSWORD }}
          TOMCAT_USR: ${{ secrets.TOMCAT_USERNAME }}
          TOMCAT_PSW: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          set -e
          cd /tmp || exit 1
          VERSION="${{ needs.Build_Artifact.outputs.version }}"
          GROUP_PATH=$(echo "${{ env.NEXUS_GROUP }}" | tr '.' '/')
          FILE_NAME="${{ env.NEXUS_ARTIFACT }}-$VERSION.war"
          DOWNLOAD_URL="${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/$GROUP_PATH/${{ env.NEXUS_ARTIFACT }}/$VERSION/$FILE_NAME"
          
          echo "ğŸ“¥ Downloading WAR from Nexus: $DOWNLOAD_URL"
          curl -f -u "$NEXUS_USR:$NEXUS_PSW" -O "$DOWNLOAD_URL"
          
          if [ ! -f "$FILE_NAME" ]; then
            echo "âŒ Failed to download WAR file"
            exit 1
          fi

          APP_NAME="${{ env.NEXUS_ARTIFACT }}"
          echo "ğŸ§¹ Undeploying old app (if any)..."
          curl -u "$TOMCAT_USR:$TOMCAT_PSW" "${{ env.TOMCAT_URL }}/undeploy?path=/$APP_NAME" || true

          echo "ğŸš€ Deploying $FILE_NAME to Tomcat at /$APP_NAME..."
          curl -f -u "$TOMCAT_USR:$TOMCAT_PSW" --upload-file "$FILE_NAME" \
            "${{ env.TOMCAT_URL }}/deploy?path=/$APP_NAME&update=true"

          echo "âœ… Deployment successful! App is live at /$APP_NAME"

  Post-Build:
    name: Post Build
    if: always()
    runs-on: [self-hosted, sonar]
    needs:
      - Checkout_Code
      - SonarQube_Analysis
      - Build_Artifact
      - Upload_Artifact_to_Nexus
      - Deploy_to_Tomcat
    steps:
      - name: Determine pipeline status
        id: status
        run: |
          results="${{ toJson(needs) }}"
          echo "Raw results: $results"
          if echo "$results" | jq -e 'to_entries[] | select(.value.result == "failure")'; then
            echo "failure=true" >> $GITHUB_OUTPUT
          elif echo "$results" | jq -e 'to_entries[] | select(.value.result != "success")'; then
            echo "failure=true" >> $GITHUB_OUTPUT  # treat cancelled/skipped as failure
          else
            echo "success=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Notify Failure
        if: steps.status.outputs.failure == 'true'
        run: echo "âŒ Pipeline failed â€” check logs for details."

      - name: Notify Success
        if: steps.status.outputs.success == 'true'
        run: echo "ğŸ‰ Pipeline completed successfully â€” application live on Tomcat!"
